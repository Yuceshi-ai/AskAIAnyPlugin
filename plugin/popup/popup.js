document.addEventListener("DOMContentLoaded",()=>{let c="https://deepread.aiagentool.com",r=60,i=null,a=null,l=!1,z=document.getElementById("show-login-btn"),d=document.getElementById("login-form-container"),t=document.getElementById("form-title"),n=document.getElementById("user-info"),s=document.getElementById("guest-view"),N=document.getElementById("show-register-btn");document.getElementById("config-btn");let F=document.getElementById("username"),W=document.getElementById("password"),m=document.getElementById("login-btn"),u=document.getElementById("login-error"),q=document.getElementById("username-display"),o=document.getElementById("user-credits-display");document.getElementById("logout-btn");let y=document.getElementById("mode-text"),p=document.getElementById("mode-link"),g=document.getElementById("mode-image"),h=document.getElementById("text-input"),v=document.getElementById("link-input"),w=document.getElementById("image-capture-area"),E=document.getElementById("mode-ask"),f=document.getElementById("mode-summarize"),P=document.getElementById("framework-container"),U=document.getElementById("question-container"),D=document.getElementById("question-input"),L=document.getElementById("custom-framework-btn"),k=document.getElementById("framework-select"),b=document.getElementById("process-btn"),I=document.getElementById("result-section"),x=document.getElementById("modal-view"),C=document.getElementById("modal-body"),J=document.getElementById("modal-close-btn"),B=document.getElementById("show-floater-btn"),G=document.getElementById("logo");document.getElementById("title");let T=document.getElementById("toggle-opacity-slider-btn"),K=document.getElementById("opacity-slider-container"),M=document.getElementById("opacity-slider"),S=document.getElementById("opacity-value"),_=((async()=>{try{var e=await fetch(chrome.runtime.getURL("popup/popup.css"));if(!e.ok)throw new Error("Failed to fetch stylesheet: "+e.statusText);var t=await e.text(),a=document.createElement("style");a.textContent=t,document.head.appendChild(a)}catch(e){console.error("Failed to inject stylesheet:",e)}})(),e=>{var t=document.createElement("p");return e&&(t.textContent=e),t.innerHTML}),H=e=>{"text"===e?(y.classList.add("active"),g.classList.remove("active"),p.classList.remove("active"),h.style.display="block",v.style.display="none",w.style.display="none"):"image"===e?(y.classList.remove("active"),p.classList.remove("active"),g.classList.add("active"),h.style.display="none",v.style.display="none",w.style.display="flex"):"link"===e&&(y.classList.remove("active"),g.classList.remove("active"),p.classList.add("active"),v.style.display="block",h.style.display="none",w.style.display="none"),chrome.storage.local.set({inputMode:e})},R=e=>{"ask"===e?(E.classList.add("active"),f.classList.remove("active"),P.style.display="none",U.style.display="block",L.style.display="none"):(E.classList.remove("active"),f.classList.add("active"),P.style.display="block",U.style.display="none",L.style.display="inline-block"),chrome.storage.local.set({processingMode:e})},Y=async e=>{C.innerHTML="<p>Loading details...</p>",x.style.display="flex";try{let r=(await chrome.storage.local.get(["token"])).token;if(!r)throw new Error("Authentication token not found.");var t=await fetch(c+"/api/article-history/"+e,{headers:{Authorization:"Bearer "+r}});if(!t.ok)throw new Error(`Failed to load details (status: ${t.status})`);var a,n=await t.json(),s=(C.innerHTML="",document.createElement("h3"));if(s.textContent=n.title||"无标题",C.appendChild(s),n.output_user_content)for(a of n.output_user_content.split(/\r?\n/)){let o=a.trim(),s=o.startsWith("concept_map_");var i=o.startsWith("mind_map_");if(s||i){let a=document.createElement("div"),n=(a.className="image-placeholder",document.createElement("div"));n.className="spinner",a.appendChild(n),C.appendChild(a);(async()=>{try{var e=o.match(/\d+/);if(!e)throw new Error("Could not extract timestamp from image identifier.");var t,a=`images/image_${e[0]}.png`,n=await fetch(c+"/api/images/refresh-url",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({imageKey:a})});if(!n.ok)throw t=await n.json(),new Error(t.message||"Failed to refresh image URL.");var s=await n.json();if(s.url)return s.url;throw new Error("URL not found in response from refresh-url endpoint.")}catch(e){throw console.error("Failed to get image URL:",e),e}})().then(e=>{let t=document.createElement("img");t.src=e,t.alt=s?"概念图":"思维导图",t.className="rendered-image",t.onload=()=>{n.remove(),a.appendChild(t)},t.onerror=()=>{n.remove(),a.textContent="Failed to load image: "+o,a.classList.add("error-message")}}).catch(e=>{console.error("Image loading process failed:",e),n.remove(),a.textContent="Error: "+e.message,a.classList.add("error-message")})}else{var l=document.createElement("div");l.textContent=a||" ",C.appendChild(l)}}}catch(e){C.innerHTML=`<p class="error-message">${_(e.message)}</p>`}},Z=()=>{x.style.display="none",C.innerHTML=""},O=(e=!1)=>{t.textContent=e?"注册":"登录",d.dataset.mode=e?"register":"login",d.style.display="block"},Q=()=>{l=!0,h.disabled=!0,b.disabled=!0,b.classList.remove("primary"),b.classList.add("processing");let e=["处理中.","处理中..","处理中..."],t=0;b.textContent=e[t],a=setInterval(()=>{t=(t+1)%e.length,b.textContent=e[t]},1e3)},$=()=>{clearInterval(a),l=!1,h.disabled=!1,b.disabled=!1,b.textContent="开始处理",b.classList.remove("processing"),b.classList.add("primary")},V=async()=>{if(!l){var{token:e,processingMode:t,selectedReadConfigId:a}=await chrome.storage.local.get(["token","processingMode","selectedReadConfigId"]),n=h.value.trim(),s=D.value.trim(),t=t||"summarize";if(e)if(n){var o={type:"text_text",outputType:"txt",inputLink:""};if("ask"===t){if(!s)return I.innerHTML='<p class="error-message" style="text-align:center;">请输入您的问题。</p>',void I.classList.remove("hidden");o.content=n,o.readConfigCustom=[{content:s,name:"自定义问题",type:"全文"}],o.title=n.substring(0,25)+" - "+s.substring(0,20)}else{t=a;if(!t)return I.innerHTML='<p class="error-message" style="text-align:center;">请选择一个处理框架。</p>',void I.classList.remove("hidden");o.content=n,o.readConfigId=parseInt(t,10),o.title=n.substring(0,50)}o.title||(o.title="无标题"),I.classList.remove("hidden"),I.innerHTML='<div class="spinner"></div>',Q();try{var r=await fetch(c+"/api/process/text",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify(o)}),i=await r.json();if(!(r.ok&&i.ok&&i.id))throw new Error(i.error||i.message||"提交任务失败，未返回有效ID");ee(i.id)}catch(e){$(),I.innerHTML=`<p class="error-message">${_(e.message)}</p>`,I.classList.remove("hidden")}}else I.innerHTML='<p class="error-message" style="text-align:center;">请输入主题内容。</p>',I.classList.remove("hidden");else I.innerHTML='<p class="error-message" style="text-align:center;">请先登录。</p>',I.classList.remove("hidden")}},X=e=>{console.log("updateResultSection called with:",e);e.input_content;var t=e.output_user_content,a=e.total_cost||0;let n=e.id;I.innerHTML=`
            <div class="result-container">
                <div class="result-column">
                    <h4>
                        <span>处理结果</span>
                        <span class="credits-consumed">消耗 ${a.toFixed(2)} 积分</span>
                        <button class="enlarge-btn" data-id="${n}" title="放大查看">↗</button>
                    </h4>
                    <div class="result-column-content">${_(t)}</div>
                </div>
            </div>
        `,I.classList.remove("hidden"),I.style.display="block",I.classList.add("fixed-height-result"),console.log("Result section display style:",I.style.display),console.log("Result section classes:",I.className),document.querySelector(`.enlarge-btn[data-id='${n}']`).addEventListener("click",()=>Y(n)),I.style.marginTop="0";e=I.querySelector(".result-container"),e&&(e.style.marginTop="0"),a=I.querySelector("h4");a&&(a.style.marginTop="0")},j=async()=>{try{var e,t,a,n=(await chrome.storage.local.get(["token"])).token;n&&(e=await fetch(c+"/api/user/info",{headers:{Authorization:"Bearer "+n},cache:"no-cache"})).ok&&(t=await e.json(),a=(o&&(o.textContent="积分: "+(t.user.balance||0)),await chrome.storage.local.get("user")).user,a)&&(a.balance=t.user.balance,await chrome.storage.local.set({user:a}))}catch(e){console.error("Failed to update user balance:",e),o&&(o.textContent="积分: 0")}},ee=s=>{let o=0;i&&clearInterval(i),b.textContent="处理中...";i=setInterval(async()=>{if(o>=r)clearInterval(i),$(),I.innerHTML='<p class="error-message">处理超时，请稍后在历史页面查看结果。</p>',I.classList.remove("hidden"),I.style.display="block";else{o++;try{var e=(await chrome.storage.local.get(["token"])).token;if(!e)throw new Error("登录已失效，请重新登录");var t=await fetch(c+"/api/article-history/"+s,{method:"HEAD",headers:{Authorization:"Bearer "+e}});if(404===t.status)b.textContent=`处理中... (${o}/${r})`;else{if(200!==t.status)throw new Error("获取处理状态时遇到未知状态: "+t.status);var a=await fetch(c+"/api/article-history/"+s,{headers:{Authorization:"Bearer "+e}});if(!a.ok)throw new Error(`获取处理结果失败 (Status: ${a.status})`);var n=await a.json();"completed"===n.processing_status?(clearInterval(i),$(),X(n),j()):"error"===n.processing_status?(clearInterval(i),$(),I.innerHTML=`<p class="error-message">处理失败: ${_(n.output_user_content)}</p>`,I.classList.remove("hidden"),I.style.display="block"):b.textContent=`处理中... (${o}/${r})`}}catch(e){clearInterval(i),$(),I.innerHTML=`<p class="error-message">${_(e.message)}</p>`,I.classList.remove("hidden"),I.style.display="block"}}},2e3)},A=(e,t=0)=>{e?(n.style.display="flex",s.style.display="none",d.style.display="none",j(),k.disabled=!1,b.disabled=!1,te()):(n.style.display="none",s.style.display="flex",d.style.display="none",q.textContent="",o.textContent="",k.disabled=!0,b.disabled=!0,k.innerHTML='<option value="">请先登录以加载框架</option>',I.classList.add("hidden"))},te=async()=>{var e=(await chrome.storage.local.get(["token"])).token;if(e)try{k.innerHTML='<option value="">正在加载框架...</option>';var t=await fetch(c+"/api/read-configs",{headers:{Authorization:"Bearer "+e}});if(!t.ok)throw new Error("无法加载框架");var n=await t.json();k.innerHTML="",k.innerHTML='<option value="">请选择一个处理框架</option>';let a=(await chrome.storage.local.get("selectedReadConfigId")).selectedReadConfigId;n.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.name,e.id==a&&(t.selected=!0),k.appendChild(t)})}catch(e){k.innerHTML=`<option value="">${e.message}</option>`}},ae=()=>{var e;window.self!==window.top&&(e=document.body.scrollHeight,window.parent.postMessage({type:"RESIZE_IFRAME",height:e},"*"))};(async()=>{new ResizeObserver(ae).observe(document.body);"floater"===new URLSearchParams(window.location.search).get("context")?(chrome.storage.local.get("windowOpacity",({windowOpacity:e})=>{e&&(document.body.style.backgroundColor=`rgba(255, 255, 255, ${e})`,M&&(M.value=e),S)&&(S.textContent=Math.round(100*e)+"%")}),T.style.display="inline-block",G.style.display="none",B.style.display="none"):(T.style.display="none",G.style.display="none",B.style.display="inline-block");var{token:e,user:t,inputMode:a,processingMode:n,ocrText:s}=await chrome.storage.local.get(["token","user","inputMode","processingMode","ocrText"]);s?(h.value=s,H("text"),chrome.storage.local.remove("ocrText")):H(a||"image"),e&&t?(A(!0,t),j()):A(!1),R(n||"summarize"),I&&I.classList.add("hidden"),b&&b.addEventListener("click",V),J&&J.addEventListener("click",Z),window.addEventListener("click",e=>{e.target===x&&Z()}),y.addEventListener("click",()=>H("text")),g.addEventListener("click",()=>H("image")),p.addEventListener("click",()=>H("link")),E.addEventListener("click",()=>R("ask")),f.addEventListener("click",()=>R("summarize")),T.addEventListener("click",()=>{var e="none"!==K.style.display;K.style.display=e?"none":"flex"}),M.addEventListener("input",async()=>{var e=M.value;S.textContent=Math.round(100*e)+"%",await chrome.storage.local.set({floaterOpacity:e}),window.self!==window.top&&window.parent.postMessage({type:"SET_OPACITY",opacity:e},"*")}),B.addEventListener("click",async()=>{try{var[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e&&e.id&&(await chrome.scripting.executeScript({target:{tabId:e.id},files:["content_script.js"]}),await chrome.tabs.sendMessage(e.id,{type:"SHOW_FLOATING_WINDOW"}),window.close())}catch(e){console.error("Could not send message to show floater:",e)}}),L&&L.addEventListener("click",async()=>{var t=(await chrome.storage.local.get(["token"])).token;try{let e=""+c;t&&(e+="?purpose=config&token="+t),chrome.tabs.create({url:e})}catch(e){console.error("处理配置页面跳转时出错:",e)}}),w.addEventListener("click",async()=>{try{if(window.self!==window.top)chrome.runtime.sendMessage({type:"RESTART_SCREENSHOT"});else{var[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.id)throw new Error("No active tab found");await chrome.scripting.executeScript({target:{tabId:e.id},files:["content_script.js"]}),await chrome.tabs.sendMessage(e.id,{type:"START_SCREENSHOT"}),window.close()}}catch(e){console.error("Screenshot error:",e)}}),z.addEventListener("click",()=>O(!1)),N.addEventListener("click",()=>O(!0)),m.addEventListener("click",async()=>{var e=F.value.trim(),t=W.value.trim();if(u.textContent="",e&&t){m.disabled=!0;var a="register"===d.dataset.mode,n=a?"/api/auth/register":"/api/auth/login";m.textContent=a?"注册中...":"登录中...";try{var s=await fetch(c+n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}),o=await s.json();if(!s.ok||!o.token)throw new Error(o.message||"登录失败");a?(u.textContent="注册成功！请使用您的新账户登录。",O(!1)):(await chrome.storage.local.set({token:o.token,user:o.user}),A(!0,o.user))}catch(e){u.textContent=e.message}finally{m.disabled=!1,m.textContent="确认"}}else u.textContent="用户名和密码不能为空。"}),k.addEventListener("change",async()=>{var e=k.value;e&&await chrome.storage.local.set({selectedReadConfigId:parseInt(e,10)})}),v.addEventListener("input",async()=>{var e=v.value.trim();if(e){var t=(await chrome.storage.local.get(["token"])).token;if(t){h.value="正在解析链接...",v.value="",H("text");try{var a=await fetch(c+"/api/get-link-text",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t},body:JSON.stringify({url:e})});if(!a.ok)throw new Error("获取链接内容失败");var n=await a.json();h.value=n.content.replace(/\n+/g,"\n")||"未解析到内容，请检查链接"}catch(e){console.error("解析链接失败:",e),h.value="解析链接失败，请重试"}}else h.value="未登录，无法解析..."}}),(s=document.getElementById("user-credits-get"))&&s.addEventListener("click",async()=>{try{var e,t=(await chrome.storage.local.get(["token"])).token;t?(e=c+"?purpose=charge&token="+t,chrome.tabs.create({url:e})):O(!1)}catch(e){console.error("处理充值跳转时出错:",e)}}),(async()=>{try{var e,[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t&&t.url&&(t.url.startsWith("chrome://")||t.url.startsWith("file://"))?(e="无法在Chrome系统页面或本地文件上使用此功能",B&&(B.disabled=!0,B.title=e),w&&(w.style.cursor="not-allowed",w.title=e),g&&(g.disabled=!0)):(B&&(B.disabled=!1,B.title="打开悬浮窗"),w&&(w.style.cursor="pointer",w.title=""),g&&(g.disabled=!1))}catch(e){console.warn("Could not check page access:",e)}})(),te()})()});